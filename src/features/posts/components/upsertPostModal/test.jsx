import { useEffect, useState } from "react"; import { useForm } from "react-hook-form"; import { useTranslation } from "react-i18next"; import { useCreatePostMutation } from "../postsApi"; import { toast } from "react-toastify"; import LoadingButton from "../../../components/LoadingButton"; import InputError from "../../../components/InputError"; const categories = [ "Plumbing", "Electrical", "AC Repair", "Painting", "Carpentry", ]; export default function UpsertPostModal({ isOpen, onClose }) { const { t } = useTranslation(); const { register, handleSubmit, reset, setValue, formState: { errors, isValid, isSubmitting }, } = useForm({ mode: "onChange", }); const [createPost, { isError, error }] = useCreatePostMutation(); const [imagePreviews, setImagePreviews] = useState([]); const [selectedFiles, setSelectedFiles] = useState([]); const [tagInputs, setTagInputs] = useState([]); const [locationLoading, setLocationLoading] = useState(false); const [coords, setCoords] = useState(null); const getUserLocation = () => { setLocationLoading(true); if (!navigator.geolocation) { toast.error("Geolocation not supported"); setLocationLoading(false); return; } navigator.geolocation.getCurrentPosition( async (pos) => { const { latitude, longitude } = pos.coords; setCoords({ lat: latitude, lng: longitude }); setValue("address", Lat: ${latitude}, Lng: ${longitude}); setLocationLoading(false); }, () => { toast.error("Failed to get location"); setLocationLoading(false); } ); }; useEffect(() => { if (isError) { const msg = error?.data?.message || error?.error || "Creating Post failed"; toast.error(msg); } }, [isError, error]); const handleImageChange = (e) => { const files = Array.from(e.target.files); const validFiles = files.filter((file) => file.name.match(/\.(jpg|jpeg|png|gif)$/i) ); if (!validFiles.length) { toast.error("Only JPG, JPEG, PNG, and GIF images are allowed!"); return; } const newPreviews = validFiles.map((file) => URL.createObjectURL(file)); setSelectedFiles([...selectedFiles, ...validFiles]); setImagePreviews([...imagePreviews, ...newPreviews]); setValue("images", [...selectedFiles, ...validFiles]); }; const removeImage = (index) => { const newFiles = selectedFiles.filter((_, i) => i !== index); const newPreviews = imagePreviews.filter((_, i) => i !== index); setSelectedFiles(newFiles); setImagePreviews(newPreviews); setValue("images", newFiles); }; const addTagInput = () => setTagInputs([...tagInputs, ""]); const updateTagInput = (index, value) => { const newTags = [...tagInputs]; newTags[index] = value; setTagInputs(newTags); setValue( "tags", newTags.filter((t) => t.trim() !== "") ); }; const removeTagInput = (index) => { const newTags = tagInputs.filter((_, i) => i !== index); setTagInputs(newTags); setValue( "tags", newTags.filter((t) => t.trim() !== "") ); }; const submitForm = async (data) => { if (!selectedFiles.length) { toast.error("You must upload at least one image"); return; } const formData = new FormData(); formData.append("title", data.title); formData.append("description", data.description); formData.append("category", data.category); if (data.tags) { data.tags.forEach((tag) => formData.append("tags[]", tag.toLowerCase())); } selectedFiles.forEach((file) => { formData.append("images", file); }); if (coords || data.address) { formData.append("location[type]", "Point"); if (coords) { formData.append("location[coordinates][]", coords.lng); formData.append("location[coordinates][]", coords.lat); } formData.append("location[address]", data.address || ""); } try { await createPost(formData); resetInputs(); onClose(); toast.success(t("postCreatedSuccessfully")); } catch (err) { console.log(err); } }; function resetInputs() { reset(); setImagePreviews([]); setSelectedFiles([]); setTagInputs([]); } if (!isOpen) return null; return ( <div className="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-40 backdrop-blur-sm"> <div className="bg-white rounded-2xl w-full max-w-xl shadow-2xl animate-fadeIn max-h-[90vh] overflow-y-auto p-6"> <h2 className="text-lg font-semibold w-full text-center"> {t("createPost")} </h2> <div className="flex items-center gap-4 mb-4"> <img className="h-12 w-12 rounded-full object-cover" src="https://plus.unsplash.com/premium_photo-1755882951408-b6d668ccca21?q=80&w=387&auto=format&fit=crop" alt="User" /> <h2 className="font-semibold">Yousef Mohamed</h2> </div> <form className="space-y-4" onSubmit={handleSubmit(submitForm)}> <input {...register("title", { required: t("titleRequired"), minLength: { value: 5, message: t("postTitleMinLength"), }, maxLength: { value: 100, message: t("postTitleMaxLength"), }, })} placeholder={t("title")} className="w-full border border-gray-300 p-3 rounded-xl mb-2" /> {errors.title && <InputError message={errors.title.message} />} <textarea {...register("description", { required: t("postDescriptionRequired"), minLength: { value: 5, message: t("postDescriptionMinLength"), }, })} placeholder={t("whatsOnYourMind")} className="w-full border border-gray-300 p-3 rounded-xl h-28 resize-none mb-2" /> <InputError message={errors.description?.message} /> <select {...register("category", { required: true })} className="w-full border border-gray-300 p-3 rounded-xl" > <option value="">{t("selectCategory")}</option> {categories.map((cat) => ( <option key={cat} value={cat}> {cat} </option> ))} </select> <div className="space-y-3 p-4 rounded-xl bg-gray-50"> <h3 className="font-semibold text-gray-700">{t("postLocation")}</h3> <div className="space-y-3 mt-3"> <input {...register("address")} type="text" placeholder={t("enterLocationManually")} className="w-full border border-gray-300 p-3 rounded-xl" /> <button type="button" onClick={getUserLocation} className="px-4 py-2 bg-green-500 text-white rounded-xl w-full cursor-pointer" > {t("useThisLocation")} </button> {locationLoading && ( <p className="text-blue-600">{t("loadingLocation")}...</p> )} <button type="button" onClick={() => { // setValue("address", userSavedAddress); }} className="px-4 py-2 bg-gray-200 rounded-xl w-full cursor-pointer" > {t("useMySavedLocation")} </button> </div> </div> <div className="space-y-3"> <label htmlFor="image-upload" className=" flex items-center justify-center gap-3 bg-linear-to-r from-blue-500 to-blue-600 text-white font-medium cursor-pointer rounded-xl py-3 px-5 shadow-md hover:shadow-xl transform transition-all duration-300 hover:scale-[1.02] active:scale-[0.98] w-[50%] m-0 " > {imagePreviews.length === 0 ? t("uploadImages") : t("addMoreImages")} </label> <p className="text-gray-500 text-xs"> {t("selectAtLeastOneImage")} </p> <input id="image-upload" type="file" {...register("images")} multiple accept=".jpg,.jpeg,.png,.gif" onChange={handleImageChange} className="hidden" /> {imagePreviews.length > 0 && ( <div className="grid grid-cols-3 gap-3"> {imagePreviews.map((src, i) => ( <div key={i} className="relative group rounded-xl overflow-hidden shadow-md" > <img src={src} className="w-full h-24 object-contain transition-transform duration-300 group-hover:scale-110" /> <button type="button" onClick={() => removeImage(i)} className=" absolute top-1 right-1 bg-red-600 text-white rounded-full w-6 h-6 flex items-center justify-center text-sm opacity-80 hover:opacity-100 transition " > × </button> </div> ))} </div> )} </div> <div className="space-y-2"> {tagInputs.map((tag, index) => ( <div key={index} className="flex items-center gap-2"> <input type="text" value={tag} onChange={(e) => updateTagInput(index, e.target.value)} placeholder={t("tag")} className="border border-gray-300 p-2 rounded-xl flex-1" /> <button type="button" onClick={() => removeTagInput(index)} className="px-3 py-1 bg-red-500 text-white rounded-xl" > × </button> </div> ))} {tagInputs.length <= 10 && ( <button type="button" onClick={addTagInput} className="px-4 py-2 bg-gray-200 rounded-xl hover:bg-gray-300 cursor-pointer" > {t("addTag")} </button> )} </div> {tagInputs.length === 10 && ( <InputError message={t("maxTagsReached")} /> )} <div className="flex justify-center items-center gap-3 pt-2 mx-auto"> <button type="button" onClick={() => { resetInputs(); onClose(); }} className="px-5 py-2 bg-gray-200 cursor-pointer w-[30%] h-14 rounded-xl" > {t("cancel")} </button> <LoadingButton isBtnLoading={isSubmitting} disabled={!isValid || !coords || selectedFiles.length === 0} title={t("send")} width="70%" style={{ margin: "1rem 0 1rem auto" }} /> </div> </form> </div> </div> ); }
    |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           ^